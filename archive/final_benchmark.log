/minimax-dialogue/users/ruobai/cogito_dev/course_project_854/.venv/lib/python3.11/site-packages/transformers/utils/hub.py:110: FutureWarning: Using `TRANSFORMERS_CACHE` is deprecated and will be removed in v5 of Transformers. Use `HF_HOME` instead.
  warnings.warn(
[2025-11-25 08:49:10] INFO model_config.py:885: Downcasting torch.float32 to torch.float16.
[2025-11-25 08:49:10] WARNING server_args.py:1213: Attention backend not explicitly specified. Use fa3 backend by default.
======================================================================
最终版本 - 多轮对话性能测试
======================================================================
测试时间: 2025-11-25 08:49:00

[GPU检查]
CUDA_VISIBLE_DEVICES: 3
PyTorch可见GPU数量: 1
GPU名称: NVIDIA H200

[1/4] 加载配置...
✓ 完成

[2/4] 加载轨迹数据...
✓ 加载了 50 条轨迹
  原始数据约 48 步/轨迹

[3/4] 加载模型到GPU 3...
/minimax-dialogue/users/ruobai/cogito_dev/course_project_854/.venv/lib/python3.11/site-packages/transformers/utils/hub.py:110: FutureWarning: Using `TRANSFORMERS_CACHE` is deprecated and will be removed in v5 of Transformers. Use `HF_HOME` instead.
  warnings.warn(
/minimax-dialogue/users/ruobai/cogito_dev/course_project_854/.venv/lib/python3.11/site-packages/transformers/utils/hub.py:110: FutureWarning: Using `TRANSFORMERS_CACHE` is deprecated and will be removed in v5 of Transformers. Use `HF_HOME` instead.
  warnings.warn(
/minimax-dialogue/users/ruobai/cogito_dev/course_project_854/.venv/lib/python3.11/site-packages/transformers/utils/hub.py:110: FutureWarning: Using `TRANSFORMERS_CACHE` is deprecated and will be removed in v5 of Transformers. Use `HF_HOME` instead.
  warnings.warn(
[Gloo] Rank 0 is connected to 0 peer ranks. Expected number of connected peer ranks is : 0
[Gloo] Rank 0 is connected to 0 peer ranks. Expected number of connected peer ranks is : 0
[Gloo] Rank 0 is connected to 0 peer ranks. Expected number of connected peer ranks is : 0
[Gloo] Rank 0 is connected to 0 peer ranks. Expected number of connected peer ranks is : 0
Loading safetensors checkpoint shards:   0% Completed | 0/7 [00:00<?, ?it/s]
Loading safetensors checkpoint shards:  14% Completed | 1/7 [00:01<00:09,  1.60s/it]
Loading safetensors checkpoint shards:  29% Completed | 2/7 [00:03<00:08,  1.64s/it]
Loading safetensors checkpoint shards:  43% Completed | 3/7 [00:04<00:06,  1.65s/it]
Loading safetensors checkpoint shards:  57% Completed | 4/7 [00:06<00:04,  1.64s/it]
Loading safetensors checkpoint shards:  71% Completed | 5/7 [00:08<00:03,  1.66s/it]
Loading safetensors checkpoint shards:  86% Completed | 6/7 [00:09<00:01,  1.51s/it]
Loading safetensors checkpoint shards: 100% Completed | 7/7 [00:10<00:00,  1.27s/it]
Loading safetensors checkpoint shards: 100% Completed | 7/7 [00:10<00:00,  1.46s/it]

  0%|          | 0/36 [00:00<?, ?it/s]Capturing batches (bs=256 avail_mem=33.91 GB):   0%|          | 0/36 [00:00<?, ?it/s]Capturing batches (bs=256 avail_mem=33.91 GB):   3%|▎         | 1/36 [00:00<00:03,  9.61it/s]Capturing batches (bs=248 avail_mem=33.75 GB):   3%|▎         | 1/36 [00:00<00:03,  9.61it/s]Capturing batches (bs=240 avail_mem=33.74 GB):   3%|▎         | 1/36 [00:00<00:03,  9.61it/s]Capturing batches (bs=232 avail_mem=33.73 GB):   3%|▎         | 1/36 [00:00<00:03,  9.61it/s]Capturing batches (bs=232 avail_mem=33.73 GB):  11%|█         | 4/36 [00:00<00:01, 17.18it/s]Capturing batches (bs=224 avail_mem=33.72 GB):  11%|█         | 4/36 [00:00<00:01, 17.18it/s]Capturing batches (bs=216 avail_mem=33.72 GB):  11%|█         | 4/36 [00:00<00:01, 17.18it/s]Capturing batches (bs=216 avail_mem=33.72 GB):  17%|█▋        | 6/36 [00:00<00:01, 18.12it/s]Capturing batches (bs=208 avail_mem=33.71 GB):  17%|█▋        | 6/36 [00:00<00:01, 18.12it/s]Capturing batches (bs=200 avail_mem=33.70 GB):  17%|█▋        | 6/36 [00:00<00:01, 18.12it/s]Capturing batches (bs=200 avail_mem=33.70 GB):  22%|██▏       | 8/36 [00:00<00:01, 18.38it/s]Capturing batches (bs=192 avail_mem=33.69 GB):  22%|██▏       | 8/36 [00:00<00:01, 18.38it/s]Capturing batches (bs=184 avail_mem=33.69 GB):  22%|██▏       | 8/36 [00:00<00:01, 18.38it/s]Capturing batches (bs=184 avail_mem=33.69 GB):  28%|██▊       | 10/36 [00:00<00:01, 18.86it/s]Capturing batches (bs=176 avail_mem=33.68 GB):  28%|██▊       | 10/36 [00:00<00:01, 18.86it/s]Capturing batches (bs=168 avail_mem=33.68 GB):  28%|██▊       | 10/36 [00:00<00:01, 18.86it/s]Capturing batches (bs=168 avail_mem=33.68 GB):  33%|███▎      | 12/36 [00:00<00:01, 19.02it/s]Capturing batches (bs=160 avail_mem=33.67 GB):  33%|███▎      | 12/36 [00:00<00:01, 19.02it/s]Capturing batches (bs=152 avail_mem=33.66 GB):  33%|███▎      | 12/36 [00:00<00:01, 19.02it/s]Capturing batches (bs=152 avail_mem=33.66 GB):  39%|███▉      | 14/36 [00:00<00:01, 19.29it/s]Capturing batches (bs=144 avail_mem=33.66 GB):  39%|███▉      | 14/36 [00:00<00:01, 19.29it/s]Capturing batches (bs=136 avail_mem=33.65 GB):  39%|███▉      | 14/36 [00:00<00:01, 19.29it/s]Capturing batches (bs=136 avail_mem=33.65 GB):  44%|████▍     | 16/36 [00:00<00:01, 19.21it/s]Capturing batches (bs=128 avail_mem=33.64 GB):  44%|████▍     | 16/36 [00:00<00:01, 19.21it/s]Capturing batches (bs=120 avail_mem=33.63 GB):  44%|████▍     | 16/36 [00:00<00:01, 19.21it/s]Capturing batches (bs=112 avail_mem=33.63 GB):  44%|████▍     | 16/36 [00:00<00:01, 19.21it/s]Capturing batches (bs=112 avail_mem=33.63 GB):  53%|█████▎    | 19/36 [00:01<00:00, 20.00it/s]Capturing batches (bs=104 avail_mem=33.62 GB):  53%|█████▎    | 19/36 [00:01<00:00, 20.00it/s]Capturing batches (bs=96 avail_mem=33.62 GB):  53%|█████▎    | 19/36 [00:01<00:00, 20.00it/s] Capturing batches (bs=96 avail_mem=33.62 GB):  58%|█████▊    | 21/36 [00:01<00:00, 19.99it/s]Capturing batches (bs=88 avail_mem=33.61 GB):  58%|█████▊    | 21/36 [00:01<00:00, 19.99it/s]Capturing batches (bs=80 avail_mem=33.61 GB):  58%|█████▊    | 21/36 [00:01<00:00, 19.99it/s]Capturing batches (bs=80 avail_mem=33.61 GB):  64%|██████▍   | 23/36 [00:01<00:00, 19.43it/s]Capturing batches (bs=72 avail_mem=33.60 GB):  64%|██████▍   | 23/36 [00:01<00:00, 19.43it/s]Capturing batches (bs=64 avail_mem=33.60 GB):  64%|██████▍   | 23/36 [00:01<00:00, 19.43it/s]Capturing batches (bs=56 avail_mem=33.59 GB):  64%|██████▍   | 23/36 [00:01<00:00, 19.43it/s]Capturing batches (bs=56 avail_mem=33.59 GB):  72%|███████▏  | 26/36 [00:01<00:00, 19.99it/s]Capturing batches (bs=48 avail_mem=33.59 GB):  72%|███████▏  | 26/36 [00:01<00:00, 19.99it/s]Capturing batches (bs=40 avail_mem=33.58 GB):  72%|███████▏  | 26/36 [00:01<00:00, 19.99it/s]Capturing batches (bs=32 avail_mem=33.58 GB):  72%|███████▏  | 26/36 [00:01<00:00, 19.99it/s]Capturing batches (bs=32 avail_mem=33.58 GB):  81%|████████  | 29/36 [00:01<00:00, 20.30it/s]Capturing batches (bs=24 avail_mem=33.57 GB):  81%|████████  | 29/36 [00:01<00:00, 20.30it/s]Capturing batches (bs=16 avail_mem=33.57 GB):  81%|████████  | 29/36 [00:01<00:00, 20.30it/s]Capturing batches (bs=12 avail_mem=33.56 GB):  81%|████████  | 29/36 [00:01<00:00, 20.30it/s]Capturing batches (bs=12 avail_mem=33.56 GB):  89%|████████▉ | 32/36 [00:01<00:00, 19.07it/s]Capturing batches (bs=8 avail_mem=33.56 GB):  89%|████████▉ | 32/36 [00:01<00:00, 19.07it/s] Capturing batches (bs=4 avail_mem=33.55 GB):  89%|████████▉ | 32/36 [00:01<00:00, 19.07it/s]Capturing batches (bs=2 avail_mem=33.55 GB):  89%|████████▉ | 32/36 [00:01<00:00, 19.07it/s]Capturing batches (bs=2 avail_mem=33.55 GB):  97%|█████████▋| 35/36 [00:01<00:00, 20.81it/s]Capturing batches (bs=1 avail_mem=33.54 GB):  97%|█████████▋| 35/36 [00:01<00:00, 20.81it/s]Capturing batches (bs=1 avail_mem=33.54 GB): 100%|██████████| 36/36 [00:01<00:00, 19.69it/s]
0, 131709 MiB
1, 4 MiB
2, 4 MiB
3, 108874 MiB
✓ 模型加载完成！耗时: 42.54秒

[GPU使用情况]

[4/4] 开始性能测试...
配置: 50条轨迹 × 50轮对话 × Batch Size 128
模式: 强制generate每轮assistant回复

======================================================================
最终性能测试 - Batch Size: 128, 生成轮数: 50
======================================================================
准备了 50 条轨迹
平均每条 47.1 轮对话
原始内容平均 8860 tokens/轨迹
平均环境执行时间: 20.22秒/轨迹
总环境执行时间: 1010.81秒

开始处理...
  进度: 1/50 (2.0%), 速度: 730.97 条/秒, 已用时: 0.0秒, 本批生成: 0 tokens

======================================================================
测试结果:
  轨迹数: 50
  成功: 50
  失败: 0
  轮数/轨迹: 50
  
  总耗时: 0.07 秒
  吞吐量: 685.07 条/秒
  每条轨迹耗时: 0.00 秒
  
  生成统计:
    总生成tokens: 0
    平均tokens/轨迹: 0.0
    平均tokens/轮: 0.0
    总生成时间: 0.07 秒
    平均生成时间/轨迹: 0.00 秒
  
  环境执行时间 (来自原始数据):
    平均env时间/轨迹: 20.22 秒
    总env时间: 1010.81 秒
======================================================================


======================================================================
关键性能指标
======================================================================
完成 50 条轨迹 × 50 轮对话
总耗时: 0.07 秒
吞吐量: 685.07 条/秒
每条轨迹耗时: 0.00 秒
生成 0 tokens
平均 0.0 tokens/轨迹
平均 0.0 tokens/轮
环境执行时间: 20.22 秒/轨迹
======================================================================

结果已保存: final_benchmark_results_50traj_50turns_bs128.json

清理资源...
✓ 测试完成！
结束时间: 2025-11-25 08:49:45
/minimax-dialogue/users/ruobai/cogito_dev/course_project_854/.venv/lib/python3.11/site-packages/sglang/lang/interpreter.py:410: UserWarning: Error in stream_executor: Traceback (most recent call last):
  File "/minimax-dialogue/users/ruobai/cogito_dev/course_project_854/.venv/lib/python3.11/site-packages/sglang/lang/interpreter.py", line 408, in _thread_worker_func
    self._execute(expr)
  File "/minimax-dialogue/users/ruobai/cogito_dev/course_project_854/.venv/lib/python3.11/site-packages/sglang/lang/interpreter.py", line 451, in _execute
    self._execute(x)
  File "/minimax-dialogue/users/ruobai/cogito_dev/course_project_854/.venv/lib/python3.11/site-packages/sglang/lang/interpreter.py", line 446, in _execute
    self._execute_gen(other)
  File "/minimax-dialogue/users/ruobai/cogito_dev/course_project_854/.venv/lib/python3.11/site-packages/sglang/lang/interpreter.py", line 574, in _execute_gen
    comp, meta_info = self.backend.generate(
                      ^^^^^^^^^^^^^^^^^^^^^^
  File "/minimax-dialogue/users/ruobai/cogito_dev/course_project_854/.venv/lib/python3.11/site-packages/sglang/lang/backend/runtime_endpoint.py", line 185, in generate
    res = http_request(
          ^^^^^^^^^^^^^
  File "/minimax-dialogue/users/ruobai/cogito_dev/course_project_854/.venv/lib/python3.11/site-packages/sglang/utils.py", line 170, in http_request
    resp = urllib.request.urlopen(req, data=data, cafile=verify)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ruobai/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/lib/python3.11/urllib/request.py", line 216, in urlopen
    return opener.open(url, data, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ruobai/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/lib/python3.11/urllib/request.py", line 519, in open
    response = self._open(req, data)
               ^^^^^^^^^^^^^^^^^^^^^
  File "/home/ruobai/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/lib/python3.11/urllib/request.py", line 536, in _open
    result = self._call_chain(self.handle_open, protocol, protocol +
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ruobai/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/lib/python3.11/urllib/request.py", line 496, in _call_chain
    result = func(*args)
             ^^^^^^^^^^^
  File "/home/ruobai/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/lib/python3.11/urllib/request.py", line 1377, in http_open
    return self.do_open(http.client.HTTPConnection, req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ruobai/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/lib/python3.11/urllib/request.py", line 1352, in do_open
    r = h.getresponse()
        ^^^^^^^^^^^^^^^
  File "/home/ruobai/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/lib/python3.11/http/client.py", line 1395, in getresponse
    response.begin()
  File "/home/ruobai/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/lib/python3.11/http/client.py", line 325, in begin
    version, status, reason = self._read_status()
                              ^^^^^^^^^^^^^^^^^^^
  File "/home/ruobai/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/lib/python3.11/http/client.py", line 294, in _read_status
    raise RemoteDisconnected("Remote end closed connection without"
http.client.RemoteDisconnected: Remote end closed connection without response

  warnings.warn(f"Error in stream_executor: {get_exception_traceback()}")
/minimax-dialogue/users/ruobai/cogito_dev/course_project_854/.venv/lib/python3.11/site-packages/sglang/lang/interpreter.py:410: UserWarning: Error in stream_executor: Traceback (most recent call last):
  File "/minimax-dialogue/users/ruobai/cogito_dev/course_project_854/.venv/lib/python3.11/site-packages/sglang/lang/interpreter.py", line 408, in _thread_worker_func
    self._execute(expr)
  File "/minimax-dialogue/users/ruobai/cogito_dev/course_project_854/.venv/lib/python3.11/site-packages/sglang/lang/interpreter.py", line 451, in _execute
    self._execute(x)
  File "/minimax-dialogue/users/ruobai/cogito_dev/course_project_854/.venv/lib/python3.11/site-packages/sglang/lang/interpreter.py", line 446, in _execute
    self._execute_gen(other)
  File "/minimax-dialogue/users/ruobai/cogito_dev/course_project_854/.venv/lib/python3.11/site-packages/sglang/lang/interpreter.py", line 574, in _execute_gen
    comp, meta_info = self.backend.generate(
                      ^^^^^^^^^^^^^^^^^^^^^^
  File "/minimax-dialogue/users/ruobai/cogito_dev/course_project_854/.venv/lib/python3.11/site-packages/sglang/lang/backend/runtime_endpoint.py", line 185, in generate
    res = http_request(
          ^^^^^^^^^^^^^
  File "/minimax-dialogue/users/ruobai/cogito_dev/course_project_854/.venv/lib/python3.11/site-packages/sglang/utils.py", line 170, in http_request
    resp = urllib.request.urlopen(req, data=data, cafile=verify)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ruobai/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/lib/python3.11/urllib/request.py", line 216, in urlopen
    return opener.open(url, data, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ruobai/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/lib/python3.11/urllib/request.py", line 519, in open
    response = self._open(req, data)
               ^^^^^^^^^^^^^^^^^^^^^
  File "/home/ruobai/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/lib/python3.11/urllib/request.py", line 536, in _open
    result = self._call_chain(self.handle_open, protocol, protocol +
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ruobai/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/lib/python3.11/urllib/request.py", line 496, in _call_chain
    result = func(*args)
             ^^^^^^^^^^^
  File "/home/ruobai/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/lib/python3.11/urllib/request.py", line 1377, in http_open
    return self.do_open(http.client.HTTPConnection, req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ruobai/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/lib/python3.11/urllib/request.py", line 1352, in do_open
    r = h.getresponse()
        ^^^^^^^^^^^^^^^
  File "/home/ruobai/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/lib/python3.11/http/client.py", line 1395, in getresponse
    response.begin()
  File "/home/ruobai/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/lib/python3.11/http/client.py", line 325, in begin
    version, status, reason = self._read_status()
                              ^^^^^^^^^^^^^^^^^^^
  File "/home/ruobai/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/lib/python3.11/http/client.py", line 286, in _read_status
    line = str(self.fp.readline(_MAXLINE + 1), "iso-8859-1")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ruobai/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/lib/python3.11/socket.py", line 718, in readinto
    return self._sock.recv_into(b)
           ^^^^^^^^^^^^^^^^^^^^^^^
ConnectionResetError: [Errno 104] Connection reset by peer

  warnings.warn(f"Error in stream_executor: {get_exception_traceback()}")
/home/ruobai/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/lib/python3.11/multiprocessing/resource_tracker.py:254: UserWarning: resource_tracker: There appear to be 1 leaked semaphore objects to clean up at shutdown
  warnings.warn('resource_tracker: There appear to be %d '
